<html>
	<head>
		<script src="/js/tools.js"></script>
		<script src="/js/image-table.js"></script>
		
		<script>
			var imageList = {};
			var websocket;
			var output;
			var selectedImage;
			var webSocketAddress;
		
			function init()
			{
				webSocketAddress = buildWebSocketAddress("status");
			    output = document.getElementById("output");
				createImageTable(output);
				openStatusSocket();
			}
			
			function decodeCommand(command) {
				var res = [];
				var items = command.split("/");
				for (var i = 0; i < items.length; i++) {
					var re = /(.*)\[(\d+)\]/i;
					var found = items[i].match(re);
					if (found == null) {
						res[i] = { value: items[i] };
					} else {
						res[i] = { value: found[1], index: found[2] };
					}
				}
				return res;
			}
			
			function openStatusSocket() {
			    websocket = new WebSocket(webSocketAddress);
			    
			    websocket.onopen = function(evt) {
			    };
			    
			    websocket.onmessage = function(evt) {
			    	if (evt.data.substring(0, 5) == "init:") {
				    	imageList = JSON.parse(evt.data.substring(5));
						output.appendItems(imageList);
						return;
			    	} else if (evt.data.substring(0, 7) == "update:") {
			    		var updateRequest = JSON.parse(evt.data.substring(7));
			    		var path_items = decodeCommand(updateRequest.command);
			    		
					    if (path_items[0].value == "") { 
					    	path_items = path_items.splice(1); // removing first '/'
					    } else {
					    	throw "First path item should be empty";
					    }
					    
					    if (path_items[0].value == "heap") { 
					    	path_items = path_items.splice(1); // removing 'heap'
					    } else {
					    	throw "Only paths started with 'heap' are supported";
					    }
					
					    if (path_items[0].value == 'images') {
						    if (output.processUpdateRequest(path_items, updateRequest.arguments)) {
						    	return;
						    }
					    }
			    	}
			    	throw 'Invalid message from client: "' + evt.data + '"';
			    };
			    websocket.onerror = function(evt) {
			    };
			    websocket.onclose = function(evt) {
			    };
			}

			window.addEventListener("load", init, false);
		</script>
		<link rel="stylesheet" type="text/css" href="style/image-table.css" />
</head>
<body>
	<div id="output"/>
</body>
</html>  
        
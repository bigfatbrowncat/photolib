<html>
	<head>
		<script src="/js/tools.js"></script>
		<script src="/js/image-table.js"></script>
		
		<script>
			var imageList = {};
			var websocket;
			var output;
			var selectedImage;
			var webSocketAddress;
		
			function init()
			{
				webSocketAddress = buildWebSocketAddress("status");
			    output = document.getElementById("output");
				createImageTable(output);
				openStatusSocket();
			}
			
			
			function openStatusSocket() {
			    websocket = new WebSocket(webSocketAddress);
			    
			    websocket.onopen = function(evt) {
			    };
			    
			    websocket.onmessage = function(evt) {
			    	if (evt.data.substring(0, 5) == "init:") {
				    	imageList = JSON.parse(evt.data.substring(5));
						output.appendItems(imageList);
			    	} else if (evt.data.substring(0, 7) == "update:") {
			    		var updateRequest = JSON.parse(evt.data.substring(7));
			    		var path_items = updateRequest.command.split("/");
			    		
					    if (path_items[0] == "") { 
					    	path_items = path_items.splice(1); // removing first '/'
					    } else {
					    	throw "First path item should be empty";
					    }
					    
					    if (path_items[0] == "heap") { 
					    	path_items = path_items.splice(1); // removing 'heap'
					    } else {
					    	throw "Only paths started with 'heap' are supported";
					    }
					
					    var image_part = path_items[0];	// getting 'images[...]'
					    if (image_part.substring(0, 6) != 'images') {
					    	throw "Only 'images' is supported under 'heap'";
					    }
					    path_items = path_items.splice(1); // removing 'images[...]'
					    
					    if (image_part == "images") {
					    	if (path_items[0] == "add") {
					    		var image = updateRequest.arguments[0];
					    		output.appendItem(image);
					    	} else if (path_items[0] == "remove") {
					    		var index = updateRequest.arguments[0];
					    		output.remove(index);
					    	}
					    } else {
							var next_part = path_items[0];
							if (next_part.substring(0, 5) == 'files') {
							    path_items = path_items.splice(1); // removing 'files[...]'
							    
							    if (next_part == "files") {
							    	if (path_items[0] == "add") {
								    	var picture = document.getElementById(image_part + ".picture");
								    	if (picture == null) {
								    		throw "Image with id '" + image_part + ".picture" + "' not found on the page";
								    	}
							    		var file = updateRequest.arguments[0];
										picture.setFile(file);
							    	}
							    }
							    
							    var field = path_items[0];
							    if (field == "name") {
							    	var picture = document.getElementById(image_part + ".picture");
							    	var file = picture.getFile();
							    	if (picture == null) {
							    		throw "Image with id '" + image_part + ".picture" + "' not found on the page";
							    	}
							    	file.name = updateRequest.arguments[0];
									picture.setFile(file);
							    }
						    } else if (next_part == 'title') {
						    	var title = document.getElementById(image_part + ".title");
						    	if (title.innerHTML != updateRequest.arguments[0]) {
						    		title.innerHTML = updateRequest.arguments[0];
						    	}
						    }
					    }
			    		
			    	} else {
			    		throw 'Invalid message from client: "' + evt.data + '"';
			    	}
			    };
			    websocket.onerror = function(evt) {
			    };
			    websocket.onclose = function(evt) {
			    };
			}

			window.addEventListener("load", init, false);
		</script>
		<link rel="stylesheet" type="text/css" href="style/image-table.css" />
</head>
<body>
	<div id="output"/>
</body>
</html>  
        